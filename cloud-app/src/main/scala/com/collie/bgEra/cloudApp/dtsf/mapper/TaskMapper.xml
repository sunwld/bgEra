<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="base.dtsfTest.mapper.DtsfMapper">
  <!--<select id="qryTask" resultType="java.util.Map">-->
    <!--SELECT NAME,nexttime,targetid FROM dtf_task-->
  <!--</select>-->

  <select id="qryAllTartInfo" resultType="com.collie.bgEra.cloudApp.dtsf.bean.TargetInfo">
    SELECT NAME,shardingvalue,description FROM dtf_targetinfo ORDER BY shardingvalue
  </select>

  <select id="qryTartInfoByName" parameterType="String" resultType="com.collie.bgEra.cloudApp.dtsf.bean.TargetInfo">
    SELECT NAME,shardingvalue,description FROM dtf_targetinfo WHERE name = #{name}
  </select>

  <select id="qryResourceMapByTarget" parameterType="String" resultType="com.collie.bgEra.cloudApp.dtsf.bean.ResourceInfo">
    SELECT t.name resourceName, t.restype resourceType  FROM dtf_resource t WHERE targetid = #{name}
  </select>

  <select id="qryTaskInfoById" parameterType="java.util.Map" resultType="com.collie.bgEra.cloudApp.dtsf.bean.TaskInfo" >
    select wkgrpname taskName,targetid targetId,schedulename taskSchedulerBean,
    description,threadpoolname taskThreadPoolName,
    status,runresult runResult,errors,thistime thisTime,
    nexttime nextTime from dtf_wkgrp_task t
    where t.targetid = #{targetId} AND t.wkgrpname = #{taskName}
  </select>

  <select id="qryWorkUnitByTask" parameterType="java.util.Map" resultType="com.collie.bgEra.cloudApp.dtsf.bean.WorkUnitInfo" >
    select * from dtf_w t
    where t.targetid = #{targetId} AND t.wkgrpname = #{taskName}
  </select>

  <insert id="insertTargetShardingMap" >
    insert  into dtf_sharding_map(zksession, dtftargetid)
    values
    <foreach collection="list" item="shardTarget" index="index" separator=",">
      (
      #{shardTarget.zkSessionId},
      #{shardTarget.dtfTargetId}
      )
    </foreach>
  </insert>

  <delete id="deleteTargetShardingMap">
    delete from dtf_sharding_map
  </delete>

  <insert id="insertZkSessionInfo" parameterType="java.util.List">
    insert  into dtf_zksession(sessionid, ismaster)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (
      #{item.zksessionId},
      #{item.isMaster}
      )
    </foreach>
  </insert>

  <delete id="deleteAllZkSessionInfo">
    delete from dtf_zksession
  </delete>

  <select id="getTargetShardingMap" resultType="com.collie.bgEra.cloudApp.dtsf.bean.ShardingTarget">
    select zksession zkSessionId,dtftargetid dtfTargetId from dtf_sharding_map
  </select>

  <select id="qryPerpredTaskListByTargets" parameterType="java.util.List" resultType="com.collie.bgEra.cloudApp.dtsf.bean.TaskInfo" >
  select targetid targetId,wkgrpname taskName,nexttime nextTime
  from dtf_wkgrp_task t
  where t.targetid in
  <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
    #{item}
  </foreach>
  </select>

</mapper>